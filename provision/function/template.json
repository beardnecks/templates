{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Transform": "AWS::Serverless-2016-10-31",
  "Description": "Creates notification lambda function",
  "Parameters": {
    "PipelineName": {
      "Type": "String",
      "Default": "",
      "Description": "prefix for CodePipeline"
    },
   "ServiceRoleArn": {
     "Type": "String",
     "Default": "",
     "Description": "Arn of codepipeline service role"
   },
    "OutputBucketName": {
      "Type": "String",
      "Default": "",
      "Description": "Name of output bucket for deployment of RPM"
    },
    "ProdPipelineTemplateURL": {
      "Type": "String",
      "Default": "",
      "Description": "URL for production pipeline cfn template"
    },
    "DevPipelineTemplateURL": {
      "Type": "String",
      "Default": "",
      "Description": "URL for development pipeline cfn template"
    }
  },
  "Resources": {
    "ProvisionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "ProvisionLambda",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:GetObjectVersion"
                  ],
                  "Resource": "arn:aws:s3:::*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "codepipeline:GetPipeline",
                    "codepipeline:ListPipelines"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:*"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudformation:CreateStack"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:*"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "provisionFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "lambda_function.lambda_handler",
        "MemorySize": 128,
        "Role": {
          "Fn::GetAtt": [
            "ProvisionRole",
            "Arn"
          ]
        },
        "Runtime": "python3.7",
        "Timeout": 300,
        "Environment": {
          "Variables": {
            "PIPELINE_NAME": {
              "Ref": "PipelineName"
            },
            "SERVICE_ROLE_ARN": {
              "Ref": "ServiceRoleArn"
            },
            "OUTPUT_BUCKET": {
              "Ref": "OutputBucketName"
            },
            "PROD_TEMPLATE_URL": {
              "Ref": "ProdPipelineTemplateURL"
            },
            "DEV_TEMPLATE_URL": {
              "Ref": "DevPipelineTemplateURL"
            }
          }
        },
        "CodeUri": "."
      }
    }
  },
  "Outputs": {
    "provisionFunctionArn": {
      "Value": {
        "Fn::GetAtt": [
          "provisionFunction",
          "Arn"
        ]
      }
    }
  }
}