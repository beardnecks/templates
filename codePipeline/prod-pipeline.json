{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "PipelineName": {
      "Type": "String",
      "Description": "Name of the CodePipeline"
    },
    "CodeBuildProjectPrefix": {
      "Type": "String",
      "Default": "",
      "Description": "prefix for created CodeBuild projects"
    },
    "SourceBucket": {
      "Type": "String",
      "Description": "S3 bucket source for the pipeline"
    },
    "SourceBucketObjectKey": {
      "Type": "String",
      "Description": "Zip file containing source code inside Source Code Bucket"
    },
    "ServiceRoleArn": {
      "Description": "ARN of notification function",
      "Type": "String"
    },
    "OutputBucketName": {
      "Type": "String",
      "Description": "Bucket containing the output artifact from the pipeline"
    }
  },
  "Resources": {
    "ArtifactStoreBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${PipelineName}-artifactstore"
        },
        "Tags": [],
        "LifecycleConfiguration": {
          "Rules": [
            {
              "ExpirationInDays": 7,
              "Status": "Enabled"
            }
          ]
        }
      }
    },
    "ArtifactStoreBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "ArtifactStoreBucket"
        },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Id": "SSEAndSSLPolicy",
          "Statement": [
            {
              "Sid": "DenyUnEncryptedObjectUploads",
              "Effect": "Deny",
              "Principal": "*",
              "Action": "s3:PutObject",
              "Resource": {
                "Fn::Sub": "arn:aws:s3:::${PipelineName}-artifactstore/*"
              },
              "Condition": {
                "StringNotEquals": {
                  "s3:x-amz-server-side-encryption": "aws:kms"
                }
              }
            },
            {
              "Sid": "DenyInsecureConnections",
              "Effect": "Deny",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": {
                "Fn::Sub": "arn:aws:s3:::${PipelineName}-artifactstore/*"
              },
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false"
                }
              }
            }
          ]
        }
      }
    },
    "PipelineCloudWatchEventRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "events.amazonaws.com"
                ]
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "cwe-pipeline-execution",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "codepipeline:StartPipelineExecution",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:codepipeline:",
                        {
                          "Ref": "AWS::Region"
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId"
                        },
                        ":",
                        {
                          "Ref": "pipeline"
                        }
                      ]
                    ]
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "eventRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Description": "--",
        "EventPattern": {
          "source": [
            "aws.s3"
          ],
          "detail-type": [
            "AWS API Call via CloudTrail"
          ],
          "detail": {
            "eventSource": [
              "s3.amazonaws.com"
            ],
            "eventName": [
              "PutObject",
              "CompleteMultipartUpload",
              "CopyObject"
            ],
            "requestParameters": {
              "bucketName": [
                {
                  "Ref": "SourceBucket"
                }
              ],
              "key": [
                {
                  "Ref": "SourceBucketObjectKey"
                }
              ]
            }
          }
        },
        "Targets": [
          {
            "Arn": {
              "Fn::Join": [
                "",
                [
                  "arn:aws:codepipeline:",
                  {
                    "Ref": "AWS::Region"
                  },
                  ":",
                  {
                    "Ref": "AWS::AccountId"
                  },
                  ":",
                  {
                    "Ref": "pipeline"
                  }
                ]
              ]
            },
            "Id": "suricata-pipeline-target",
            "RoleArn": {
              "Fn::GetAtt": [
                "PipelineCloudWatchEventRole",
                "Arn"
              ]
            }
          }
        ]
      }
    },
    "pipeline": {
      "Type": "AWS::CodePipeline::Pipeline",
      "DependsOn": "ArtifactStoreBucket",
      "Properties": {
        "Name": {
          "Ref": "PipelineName"
        },
        "RoleArn": {
          "Ref": "ServiceRoleArn"
        },
        "ArtifactStore": {
          "Type": "S3",
          "Location": {
            "Fn::Sub": "${PipelineName}-artifactstore"
          }
        },
        "Stages": [
          {
            "Name": "Source",
            "Actions": [
              {
                "Name": "Source",
                "ActionTypeId": {
                  "Category": "Source",
                  "Owner": "AWS",
                  "Provider": "S3",
                  "Version": "1"
                },
                "RunOrder": 1,
                "Configuration": {
                  "PollForSourceChanges": "false",
                  "S3Bucket": {
                    "Ref": "SourceBucket"
                  },
                  "S3ObjectKey": {
                    "Ref": "SourceBucketObjectKey"
                  }
                },
                "OutputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "InputArtifacts": [],
                "Region": {
                  "Ref": "AWS::Region"
                },
                "Namespace": "SourceVariables"
              }
            ]
          },
          {
            "Name": "Testing",
            "Actions": [
              {
                "Name": "UnitTest",
                "ActionTypeId": {
                  "Category": "Test",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "RunOrder": 1,
                "Configuration": {
                  "ProjectName": {
                    "Fn::Sub": "${CodeBuildProjectPrefix}-UnitTest"
                  }
                },
                "OutputArtifacts": [],
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "Region": {
                  "Ref": "AWS::Region"
                }
              },
              {
                "Name": "RustTest",
                "ActionTypeId": {
                  "Category": "Test",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "RunOrder": 1,
                "Configuration": {
                  "ProjectName": {
                    "Fn::Sub": "${CodeBuildProjectPrefix}-RustTest"
                  }
                },
                "OutputArtifacts": [],
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "Region": {
                  "Ref": "AWS::Region"
                }
              },
              {
                "Name": "Coccinelle",
                "ActionTypeId": {
                  "Category": "Test",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "RunOrder": 2,
                "Configuration": {
                  "ProjectName": {
                    "Fn::Sub": "${CodeBuildProjectPrefix}-CoccinelleTest"
                  }
                },
                "OutputArtifacts": [],
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "Region": {
                  "Ref": "AWS::Region"
                }
              },
              {
                "Name": "ClangTest",
                "ActionTypeId": {
                  "Category": "Test",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "RunOrder": 2,
                "Configuration": {
                  "ProjectName": {
                    "Fn::Sub": "${CodeBuildProjectPrefix}-ClangTest"
                  }
                },
                "OutputArtifacts": [],
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "Region": {
                  "Ref": "AWS::Region"
                }
              },
              {
                "Name": "SuricataVerify",
                "ActionTypeId": {
                  "Category": "Test",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "RunOrder": 2,
                "Configuration": {
                  "ProjectName": {
                    "Fn::Sub": "${CodeBuildProjectPrefix}-VerifyTest"
                  }
                },
                "OutputArtifacts": [],
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "Region": {
                  "Ref": "AWS::Region"
                }
              }
            ]
          },
          {
            "Name": "Build",
            "Actions": [
              {
                "Name": "PackagingRPM",
                "ActionTypeId": {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "RunOrder": 1,
                "Configuration": {
                  "ProjectName": {
                    "Fn::Sub": "${CodeBuildProjectPrefix}-Packaging"
                  }
                },
                "OutputArtifacts": [
                  {
                    "Name": "RPMBuildArtifact"
                  }
                ],
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "Region": {
                  "Ref": "AWS::Region"
                },
                "Namespace": "BuildVariables"
              },
              {
                "Name": "DockerBuild",
                "ActionTypeId": {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "RunOrder": 1,
                "Configuration": {
                  "ProjectName": {
                    "Fn::Sub": "${CodeBuildProjectPrefix}-DockerBuild"
                  }
                },
                "OutputArtifacts": [
                  {
                    "Name": "DockerBuildArtifact"
                  }
                ],
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "Region": {
                  "Ref": "AWS::Region"
                }
              }
            ]
          },
          {
            "Name": "Deploy",
            "Actions": [
              {
                "Name": "DeployS3",
                "ActionTypeId": {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "S3",
                  "Version": "1"
                },
                "RunOrder": 1,
                "Configuration": {
                  "BucketName": {
                    "Ref": "OutputBucketName"
                  },
                  "Extract": "true"
                },
                "OutputArtifacts": [],
                "InputArtifacts": [
                  {
                    "Name": "RPMBuildArtifact"
                  }
                ],
                "Region": {
                  "Ref": "AWS::Region"
                }
              },
              {
                "Name": "DockerDeploy",
                "ActionTypeId": {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "RunOrder": 1,
                "Configuration": {
                  "ProjectName": {
                    "Fn::Sub": "${CodeBuildProjectPrefix}-DockerDeploy"
                  },
                  "PrimarySource": "SourceArtifact"
                },
                "InputArtifacts": [
                  {
                    "Name": "DockerBuildArtifact"
                  }
                ],
                "Region": {
                  "Ref": "AWS::Region"
                }
              }
            ]
          }
        ]
      }
    }
  }
}
