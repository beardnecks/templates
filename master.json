{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Creates nested stacks containing CodeBuild templates",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "General Settings"
                    },
                    "Parameters": [
                        "BuildImage"
                    ]
                },
                {
                    "Label": {
                        "default": "Unit Test settings"
                    },
                    "Parameters": [
                        "UnitTestName",
                        "UnitTestBuildSpecFileName",
                        "UnitTestTemplateURL"
                    ]
                },
                {
                    "Label": {
                        "default": "Verify Test settings"
                    },
                    "Parameters": [
                        "VerifyTestName",
                        "VerifyBuildSpecFileName",
                        "VerifyTestTemplateURL"
                    ]
                },
                {
                    "Label": {
                        "default": "Packaging Test settings"
                    },
                    "Parameters": [
                        "PackagingBuildName",
                        "PackagingBuildSpecFileName",
                        "PackagingTemplateURL"
                    ]
                },
                {
                    "Label": {
                        "default": "Docker Build and Deploy settings"
                    },
                    "Parameters": [
                        "DockerName",
                        "DockerBuildSpecFileName",
                        "DockerTemplateURL"
                    ]
                },
                {
                    "Label": {
                        "default": "CodePipeline settings"
                    },
                    "Parameters": [
                        "ArtifactStoreName",
                        "PipelineName",
                        "SourceBucket",
                        "SourceBucketObjectKey",
                        "OutputBucketName",
                        "PipelineTemplateURL"
                    ]
                }
            ],
            "ParameterLabels": {
                "UnitTestName": {
                    "default": "Project name of unittest"
                },
                "VerifyTestName": {
                    "default": "Project name of verify tests"
                },
                "PackagingBuildName": {
                    "default": "Project name of packaging stage"
                },
                "DockerName": {
                    "default": "Project name of Docker stage"
                },
                "UnitTestBuildSpecFileName": {
                    "default": "File path of the buildspec file of the unit test"
                },
                "VerifyBuildSpecFileName": {
                    "default": "File path of the buildspec file of the verify tests"
                },
                "PackagingBuildSpecFileName": {
                    "default": "File path of the buildspec file of the packaging stage"
                },
                "DockerBuildSpecFileName": {
                    "default": "File path of the buildspec file of the Docker stage"
                },
                "BuildImage": {
                    "default": "ECR address of docker image used for building"
                },
                "UnitTestTemplateURL": {
                    "default": "S3 URL of unit test template"
                },
                "VerifyTestTemplateURL": {
                    "default": "S3 URL of verify test template"
                },
                "PackagingTemplateURL": {
                    "default": "S3 URL of packaging template"
                },
                "DockerTemplateURL": {
                    "default": "S3 URL of Docker template"
                },
                "ArtifactStoreName": {
                    "default": "S3 bucket that stores pipeline artifacts."
                },
                "PipelineName": {
                    "default": "Name of the CodePipeline"
                },
                "SourceBucket": {
                    "default": "S3 bucket source for the pipeline"
                },
                "SourceBucketObjectKey": {
                    "default": "Zip file containing source code inside Source Code Bucket"
                },
                "OutputBucketName": {
                    "default": "Bucket containing the output artifact from the pipeline"
                },
                "PipelineTemplateURL": {
                    "default": "S3 URL for the pipeline template"
                }
            }
        }
    },
    "Parameters": {
        "UnitTestName": {
            "Description": "Name of the unittest build project",
            "Type": "String",
            "Default": "unittest"
        },
        "VerifyTestName": {
            "Description": "Name of the verify test build project",
            "Type": "String",
            "Default": "verify"
        },
        "PackagingBuildName": {
            "Description": "Name of the unittest build project",
            "Type": "String",
            "Default": "packaging"
        },
        "DockerName": {
            "Description": "Name of the docker build project",
            "Type": "String",
            "Default": "packaging"
        },
        "UnitTestBuildSpecFileName": {
            "Description": "Filename of the buildspec.yaml",
            "Type": "String",
            "Default": ""
        },
        "VerifyBuildSpecFileName": {
            "Description": "Filename of the buildspec.yaml",
            "Type": "String",
            "Default": ""
        },
        "PackagingBuildSpecFileName": {
            "Description": "Filename of the buildspec.yaml",
            "Type": "String",
            "Default": ""
        },
        "DockerBuildSpecFileName": {
            "Description": "Filename of the buildspec.yaml",
            "Type": "String",
            "Default": ""
        },
        "BuildImage": {
            "Description": "Docker container to run the build",
            "Type": "String",
            "Default": ""
        },
        "UnitTestTemplateURL": {
            "Description": "S3 URL for unit test template",
            "Type": "String",
            "Default": ""
        },
        "VerifyTestTemplateURL": {
            "Description": "S3 URL for verify test template",
            "Type": "String",
            "Default": ""
        },
        "PackagingTemplateURL": {
            "Description": "S3 URL for packaging build template",
            "Type": "String",
            "Default": ""
        },
        "DockerTemplateURL": {
            "Description": "S3 URL for docker build template",
            "Type": "String",
            "Default": ""
        },
        "ArtifactStoreName": {
            "Type": "String",
            "Default": "",
            "Description": "S3 bucket that stores pipeline artifacts."
        },
        "PipelineName": {
            "Type": "String",
            "Default": "",
            "Description": "Name of the CodePipeline"
        },
        "SourceBucket": {
            "Type": "String",
            "Default": "",
            "Description": "S3 bucket source for the pipeline"
        },
        "SourceBucketObjectKey": {
            "Type": "String",
            "Default": "",
            "Description": "Zip file containing source code inside Source Code Bucket"
        },
        "OutputBucketName": {
            "Type": "String",
            "Default": "Pipeline-output-bucket",
            "Description": "Bucket containing the output artifact from the pipeline"
        },
        "PipelineTemplateURL": {
            "Type": "String",
            "Default": "",
            "Description": "S3 URL for the pipeline template"
        }
    },
    "Resources": {
        "CodeBuildIamRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codebuild.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Path": "/",
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AWSCodeBuildAdminAccess",
                    "arn:aws:iam::aws:policy/AWSCodePipelineFullAccess",
                    "arn:aws:iam::aws:policy/AmazonS3FullAccess",
                    "arn:aws:iam::aws:policy/CloudWatchFullAccess",
                    "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess"
                ]
            }
        },
        "UnitTest": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "Parameters": {
                    "BuildName": {
                        "Ref": "UnitTestName"
                    },
                    "BuildImage": {
                        "Ref": "BuildImage"
                    },
                    "BuildSpecFileName": {
                        "Ref": "UnitTestBuildSpecFileName"
                    },
                    "IAMRole": {
                        "Fn::GetAtt": [
                            "CodeBuildIamRole",
                            "Arn"
                        ]
                    }
                },
                "TemplateURL": {
                    "Ref": "UnitTestTemplateURL"
                }
            }
        },
        "Verify": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "Parameters": {
                    "BuildName": {
                        "Ref": "VerifyTestName"
                    },
                    "BuildImage": {
                        "Ref": "BuildImage"
                    },
                    "BuildSpecFileName": {
                        "Ref": "VerifyBuildSpecFileName"
                    },
                    "IAMRole": {
                        "Fn::GetAtt": [
                            "CodeBuildIamRole",
                            "Arn"
                        ]
                    }
                },
                "TemplateURL": {
                    "Ref": "VerifyTestTemplateURL"
                }
            }
        },
        "Packaging": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "Parameters": {
                    "BuildName": {
                        "Ref": "PackagingBuildName"
                    },
                    "BuildImage": {
                        "Ref": "BuildImage"
                    },
                    "BuildSpecFileName": {
                        "Ref": "PackagingBuildSpecFileName"
                    },
                    "IAMRole": {
                        "Fn::GetAtt": [
                            "CodeBuildIamRole",
                            "Arn"
                        ]
                    }
                },
                "TemplateURL": {
                    "Ref": "PackagingTemplateURL"
                }
            }
        },
        "Docker": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "Parameters": {
                    "BuildName": {
                        "Ref": "DockerName"
                    },
                    "BuildSpecFileName": {
                        "Ref": "DockerBuildSpecFileName"
                    },
                    "IAMRole": {
                        "Fn::GetAtt": [
                            "CodeBuildIamRole",
                            "Arn"
                        ]
                    }
                },
                "TemplateURL": {
                    "Ref": "DockerTemplateURL"
                }
            }
        },
        "pipeline": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "Parameters": {
                    "ArtifactStoreName": {
                        "Ref": "ArtifactStoreName"
                    },
                    "PipelineName": {
                        "Ref": "PipelineName"
                    },
                    "SourceBucket": {
                        "Ref": "SourceBucket"
                    },
                    "SourceBucketObjectKey": {
                        "Ref": "SourceBucketObjectKey"
                    },
                    "OutputBucketName": {
                        "Ref": "OutputBucketName"
                    },
                    "UnitTestName": {
                        "Ref": "UnitTestName"
                    },
                    "VerifyTestName": {
                        "Ref": "VerifyTestName"
                    },
                    "PackagingName": {
                        "Ref": "PackagingBuildName"
                    },
                    "DockerName": {
                        "Ref": "DockerName"
                    }
                },
                "TemplateURL": {
                    "Ref": "PipelineTemplateURL"
                }
            }
        }
    }
}